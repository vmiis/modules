<section>
      <div id=toolbar__ID>
            <a id=back__ID>Back</a> <span class=tab__ID></span> <a id=save__ID style="display:none">Load</a>
            <input placeholder='table ID' id=tid__ID type=text />
            <input placeholder='filter' id=keyword__ID type=text /> <a id=query__ID>Load</a>
            <span class=tab__ID></span>Page Size: <select id=page_size__ID><option>30</option><option>50</option><option>100</option><option>200</option></select><span class=tab__ID></span>
            <span id=I__ID style="display:none">0</span><span id=A__ID></span>
            <img id=p__ID src="__BASE__/vmiis/Common-Code/image/p.png" ><img id=n__ID src="__BASE__/vmiis/Common-Code/image/n.png" >
            <span class=tab__ID></span><span class=tab__ID></span>
            <a id=import__ID>Import</a><form id=fileform__ID><input style='display:none' type=file id=import_file__ID /></form>
      </div>
      <table id=grid__ID></table>
</section>
<script>
    function F__ID(){
        //-------------------------------------
        VmInclude:__BASE__/vmiis/Common-Code/grid/grid2.js
        VmInclude:__BASE__/vmiis/Common-Code/style/ease-in-out.js
        //-------------------------------------
        $('#D__ID').on('load',function(){  _set_req(); _request_data();  })
        //-------------------------------------
        _set_req=function(){
            _db_pid=$('#tid__ID').val();
            if(_db_pid=='') return false;
            var sql="with tb as (select Information,DateTime,Author,RowNum=row_number() over (order by ID DESC)";
            sql+=" from [TABLE-"+_db_pid+"-@S1] )";
            sql+="select Information from tb where RowNum between @I6 and @I7";
            var sql_n="select count(ID) from [TABLE-"+_db_pid+"-@S1]";
            _req={cmd:'query_records',db_pid:_db_pid,sql:sql,sql_n:sql_n,s1:'"'+$('#keyword__ID').val()+'"',I:$('#I__ID').text(),page_size:$('#page_size__ID').val()}
        }
        //-------------------------------------
        _data_process=function(){
            var all_headers=[];
            _fields="";
            for(var i=0;i<_records.length;i++){
                var record=_records[i];
                for (var key in record) {
                    if (record.hasOwnProperty(key)) {
                        if($.inArray(key, all_headers)==-1){
                            all_headers.push(key);
                            if(_fields!="") _fields+=",";
                            _fields+=key;
                        }
                    }
                }
            }
            _fields="_Form,"+_fields;
        }
        //-------------------------------------
        $('#import__ID').on('click',function(){
            $('#fileform__ID')[0].reset();
            $('#import_file__ID').trigger('click');
        })
        //-------------------------------------
        $('#import_file__ID').on('change',function(evt){
            var files = evt.target.files;
            if(files.length>0){
                if(confirm("Are you sure to import "+files[0].name+"?\n")){
                    var reader = new FileReader();
                    reader.onload = (function(e) {
                        var db_fields="";
                        var file_fields="";
                        var contents=e.target.result;
                        var lines=contents.replace(/\r\n/g,'\r').split('\r');
                        file_fields=lines[0].replace(/\t/g,',');
                        var sql="select top 1 information from [TABLE-"+$('#tid__ID').val()+"] order by ID DESC";
                        var req={cmd:'query_records',sql:sql}
                        $VmAPI.request({data:req,callback:function(res){
                            if(res.records.length==1){
                                var record=res.records[0];
                                for (var key in record) {
                                    if (record.hasOwnProperty(key)) {
                                        if(db_fields!="") db_fields+=",";
                                        db_fields+=key;
                                    }
                                }
                                if(db_fields=="" || db_fields==file_fields){
                                    data_import(contents);
                                }
                                else{
                                    alert("The format of data in the file is different from the one in database.")
                                }
                            }
                        }})
                    });
                    reader.readAsText(files[0]);
                }
            }
        })
        //-------------------------------------
        var data_import=function(contents){
            var gNumber_to_process,gNumber_completed,gDialog_module_id;
            var gI=0,gLines,gTab,gFields,gHeader;
            var gLoop;
            var gOK;
            //-------------------------------------
            var one_loop=function(){
                if(gOK==0) return;
                gOK=0;
                var items=gLines[gI].splitCSV(gTab);
                //--------------------------------------
                //create a record rd
                var rd={};
                if(items.length==1 && items[0]==''){} //this is empty line
                else{
                    for(var j=0;j<gFields.length;j++){
                        var field_name=gFields[j].split('|')[0];
                        var field_id=gFields[j].split('|').pop();
                        var index=gHeader.indexOf(field_name.replace(/ /g,'_'));
                        if(index!=-1 && index<items.length)  rd[field_id]=items[index];  //index>=items.length: the data line is too short
                    }
                }
                //--------------------------------------
                if(jQuery.isEmptyObject(rd)===false){ //not empty record
                    //add
                    _dbv={};
                    var req={cmd:"add_record",db_pid:_db_pid.toString(),data:rd,dbv:_dbv};
                    $VmAPI.request({data:req,callback:function(res){
                        gNumber_completed++;
                        processing_file_end();
                    }})
                    //------------------------------------------
                }
                else{
                    gNumber_to_process--;
                    processing_file_end();
                }
                console.log(gI+'/'+gNumber_to_process)
                if(gI>=gNumber_to_process){
                    clearInterval(gLoop);
                    return;
                }
                gI++;
            }
            //-------------------------------------
            var processing_file=function(){
                gLines=contents.replace(/\r\n/g,'\r').split('\r');
                if(gLines.length>1){
                    gNumber_to_process=gLines.length-1; //-1: not count header line
                    gNumber_completed=0;
                    gDialog_module_id=$vm.get_module_id({name:'_system_import_dialog_module'})
                    gTab='\t';
                    var n1=gLines[0].split('\t').length;
                    var n2=gLines[0].split(',').length;
                    if(n2>n1) gTab=',';
                    gHeader=gLines[0].splitCSV(gTab);
                    for(var k=0;k<gHeader.length;k++){gHeader[k]=gHeader[k].trim().replace(/ /g,'_');}
                    gFields=_fields.split(',');
                    gI=1; //not 0, start from second line, the first line is header
                    $vm.open_dialog({name:'_system_import_dialog_module'});
                    gOK=1;
                    gLoop=setInterval(one_loop, 500);
                }
            }
            //-------------------------------------
            var processing_file_end=function(){
                gOK=1;
                $('#import_num'+gDialog_module_id).text(gNumber_completed.toString()+"/"+gNumber_to_process.toString());
                if(gNumber_to_process<=gNumber_completed){
                    gNumber_to_process=-1;
                    $vm.close_dialog({name:'_system_import_dialog_module'});
                    alert(gNumber_completed.toString()+" records have been imported.");
                    _set_req(); _request_data();
                }
            }
            //-------------------------------------
            processing_file();
        }
    }
</script>
<style>
    VmInclude:__BASE__/vmiis/Common-Code/grid/grid.css
</style>
