<section>
    <div id=toolbar__ID>
          <a id=back__ID>Back</a> <span id=parent_name__ID></span> <span id=ns__ID><a id=new__ID>New</a> <a id=save__ID>Save</a></span><span class=tab__ID></span><input placeholder='Name' id=keyword__ID type=text />
          <a id=query__ID>Load</a>
          <span id=multi__ID>
              <span class=tab__ID></span>Page Size: <select id=page_size__ID><option>30</option><option>50</option><option>100</option><option>200</option></select><span class=tab__ID></span>
              <span id=I__ID style="display:none">0</span><span id=A__ID></span>
              <img id=p__ID src="__LIB__/vmiis/Common-Code/image/p.png" ><img id=n__ID src="__LIB__/vmiis/common-code/image/n.png" >
          </span>
          <span id=elapsed__ID style='float:right'></span>
    </div>
    <div id=table__ID>
        <table id=grid__ID></table>
    </div>
</section>
<script>
function F__ID(){
	//-------------------------------------
	VmInclude:__LIB__/vmiis/Common-Code/grid/grid2.js
	VmInclude:__LIB__/vmiis/Common-Code/style/ease-in-out_2.js
	//-------------------------------------
	var fields="Name";
	fields+=",_gridHidden|Table_ID,_gridHidden|URL,_gridHidden|Input,_gridHidden|Single_Child";
	_fields="_Form,"+fields+",Submit Date|DateTime,Submitted by|Author,_Delete";
	//-------------------------------------
	$('#D__ID').on('load',function(){
		$('#parent_name__ID').text($vm.vm['__ID'].op.parent_name);
		$('#ns__ID').show();
		if(_res.pms=='1000'){
			$('#ns__ID').hide();
		}
		_set_req(); _request_data();
	})
	//-------------------------------------
	_cell_render=function(records,I,field,td,set_value,source){
	    switch(field){
			case 'Single_Child':
				td.html('<input type=checkbox />');
				VmInclude:__BASE__/vmiis/Common-Code/grid/field_checkbox.js
				break;
			case 'Name':
	            if(records[I].UID==null || records[I].UID==undefined) return;
	            if(source=='form'){
	                records[I].vm_readonly[field]=false;
	                return;
	            }
	            records[I].vm_readonly[field]=true;
				var nm=$('<div/>').html(records[I][field]).text();
				if(_res.pms=='1000'){
					var digit=nm.split(' ')[0];
					if(isNaN(digit)==false){
						nm=nm.replace(digit,'').trim();
					}
				}
				else{
					var digit=nm.split(' ')[0];
					if(isNaN(digit)==false){
						nm=nm.replace(digit,'').trim();
						nm="<span style='color:#aaa'>"+digit+"</span> "+nm;
					}
				}
				if(records[I].Table_ID=='' || records[I].Table_ID==undefined) td.html("â–ª <u style='cursor:pointer;'>"+nm+"</u>");
	            else td.html("  <u style='cursor:pointer;'>"+nm+"</u>");
	            td.find('u').on('click',function(){
					if( $(this).hasClass( 'not_allowed__ID' )===true){
			              alert("No permission!");
			              return;
			        }
	                var url=records[I].URL;
	                if(url.length>0 && url[0]=='/'){
						url="__LIB__"+url;
	                    var v={}
	                    try{
							var obj=records[I].Input;
							if(obj[0]!='{') obj='{'+obj+'}';
							v=JSON.parse(obj);
							v.UID=records[I].UID;
	                    }catch (e) {}
						var module="M"+records[I].UID;
	                    $vm.module_list[module]={
	                        table_id:records[I].Table_ID,
	                        url:url,
	                        var:v,
	                    }
	                    $vm.load_module_by_name(module,$vm.root_layout_content_slot,{})
	                }
					else{
	                    if($vm.trust_path!==undefined){
	                        for(var i=0;i<$vm.trust_path.length;i++){
	                            var len=$vm.trust_path[i].length;
	                            if(url.indexOf($vm.trust_path[i])!==-1 && url.substring(0,len)==$vm.trust_path[i]){
	                                var v={}
	                                try{
										var obj=records[I].Input;
										if(obj[0]!='{') obj='{'+obj+'}';
	                                    v=JSON.parse(obj);
										v.UID=records[I].UID;
	                                }catch (e) {}
	    							var module="M"+records[I].UID;
									if($vm.module_list[module]==undefined){
		                                $vm.module_list[module]={
		                                    table_id:records[I].Table_ID,
		                                    url:url,
		                                    var:v,
		                                }
									}
									var slot=$vm.root_layout_content_slot;
									if(records[I].Single_Child=='1') slot=undefined;
	                                $vm.load_module_by_name(module,slot,$vm.vm['__ID'].op.parent_info)
	                                return;
	                            }
	                        }
	                    }
						alert("The url ("+records[I].URL+") is not trusted.")
					}
	            })
	            break;
	    }
	}
	//-------------------------------------
	_before_submit=function(record,dbv){
	    if(record.Input!=""){
	        try{
				var obj=record.Input;
				if(obj[0]!='{') obj='{'+obj+'}';
	            JSON.parse(obj);
	        }catch (e) {
	            alert(e);
	            return false;
	        }
	    }
	    dbv.S1=record.Name;
		dbv.PUID=_module.var.UID;
	    return true;
	};
	//-------------------------------------
	_set_req=function(){
	    var sql="with tb as (select Information,ID,UID,PUID,DateTime,Author,RowNum=row_number() over (order by S1) from [TABLE-"+_db_pid+"] where PUID="+_module.var.UID+" and S1 like '%'+@S1+'%')";
	    sql+="select Information,ID,UID,PUID,DateTime,Author,RowNum from tb where RowNum between @I6 and @I7";
	    var sql_n="select count(ID) from [TABLE-"+_db_pid+"] where PUID="+_module.var.UID+" and S1 like '%'+@S1+'%'";
	    _req={cmd:'query_records',db_pid:_db_pid,sql:sql,sql_n:sql_n,s1:$('#keyword__ID').val(),I:$('#I__ID').text(),page_size:$('#page_size__ID').val()}
	}
	//-------------------------------------
	var tr_permission={};
	//-------------------------------------
	var set_u_permission=function($u,tid){
		$VmAPI.request({data:{cmd:'query_permission',db_pid:tid},callback:function(res){
			if(res.pms!=undefined){
				var p=parseInt(res.pms) & parseInt("1111",2); //read,write,delete,full
				if(p==0){
					tr_permission['P'+tid]=0;
					$u.addClass('not_allowed__ID')
				}
				else{
					tr_permission['P'+tid]=1;
					$u.removeClass('not_allowed__ID');
				}
			}
		}})
	}
	//---------------------------------------------------------------
	_data_process_after_render=function(){
		if(_res.pms=='1000'){
			$('#grid__ID th:nth-child(2)').hide()
			$('#grid__ID td:nth-child(2)').hide()
			$('#grid__ID th:nth-child(4)').hide()
			$('#grid__ID td:nth-child(4)').hide()
			$('#grid__ID th:nth-child(5)').hide()
			$('#grid__ID td:nth-child(5)').hide()
			$('#grid__ID th:nth-child(6)').hide()
			$('#grid__ID td:nth-child(6)').hide()
	    }
		if($vm.server=='development') return;
		$('#grid__ID tr').each(function(index){
			if(index!=0){
				var $u=$(this).find('td').eq(2).find('u');
				var tid=_records[index-1].Table_ID;
				var per=tr_permission['P'+tid]
				if(tid==undefined || tid=='') per=1;
				if(per==undefined){
					set_u_permission($u,tid)
				}
				else if(per==1){
					$u.removeClass('not_allowed__ID');
				}
				else if(per==0){
					$u.addClass('not_allowed__ID')
				}
			}
		})
	}
	//-------------------------------------
	var m_name='M'+_db_pid+'child_module_form'
	var this_module_name=$vm.vm['__ID'].name;
	$vm.module_list[this_module_name].form_module=m_name;
	if($vm.module_list[m_name]==undefined){
		$vm.module_list[m_name]={table_id:_db_pid,url:'https://vmiis.github.io/modules/portal/child_module.form.html'}
	}
	//-------------------------------------
}
</script>
<style>
    VmInclude:__LIB__/vmiis/Common-Code/grid/grid.css
    VmInclude:__LIB__/vmiis/Common-Code/style/ease-in-out_2.css
	.not_allowed__ID{
	    color:#888!Important;
	    cursor:not-allowed!Important;
		text-decoration: none;
	}
    @media screen and (max-width:900px){
        #grid__ID{
            font-size:120%;
        }
    }
</style>
