<section>
    <div id=toolbar__ID>
          <a id=back__ID>Back</a> <span id=ns__ID><a id=new__ID>New</a> <a id=save__ID>Save</a></span><span class=tab__ID></span><input placeholder='filter' id=keyword__ID type=text />
          <input id=department__ID placeholder='Department' type=text ></input>
          <a id=query__ID>Load</a> <a id=pv__ID >Print</a>
          <span id=multi__ID>
              <span class=tab__ID></span>Page Size: <select id=page_size__ID><option>30</option><option>50</option><option>100</option><option>200</option></select><span class=tab__ID></span>
              <span id=I__ID style="display:none">0</span><span id=A__ID></span>
              <img id=p__ID src="__BASE__/vmiis/Common-Code/image/p.png" ><img id=n__ID src="__BASE__/vmiis/Common-Code/image/n.png" >
          </span>
    </div>
    <div id=table__ID>
        <table id=grid__ID></table>
    </div>
</section>
<script>
    function F__ID(){
        //-------------------------------------
        VmInclude:__BASE__/vmiis/Common-Code/grid/grid.js
        VmInclude:__BASE__/vmiis/Common-Code/style/ease-in-out.js
        //-------------------------------------
        var fields="Photo,_More,Title,First_Name,Last_Name,Gender,Department,Position,Location,Email,Phone,Login_Name";
        _fields="_Form,"+fields+",Submit Date|DateTime,Submitted by|Author,_Delete";
        //-------------------------------------
        if($vm.user=='guest') _fields=_fields.replace(',_Delete','');
        //-------------------------------------
        $('#D__ID').on('load',function(){ _set_req(); _request_data(); })
        //-------------------------------------
        $('#department__ID').autocomplete({
            minLength:0,
            source:function(request,response){
                var sql="with tb as (select name=S1 from [TABLE-"+_module.var.department_tid+"])";
                sql+=" select top 10 name,value=name from tb where name like '%'+@S1+'%' ";
                $VmAPI.request({data:{cmd:'auto',s1:request.term,sql:sql,minLength:0},callback:function(res){
                    response($vm.autocomplete_list(res.table));
                }});
            },
        })
        $('#department__ID').focus(function(){$('#department__ID').autocomplete("search","");});
        //-------------------------------------
        _cell_render=function(records,I,field,td,set_value,source){
            switch(field){
                case '_More':
                    records[I].vm_custom[field]=true;
                    if(records[I].UID==null || records[I].UID==undefined) return;
                    td.html("<u style='cursor:pointer;'>More...</u>");
                    td.find('u').on('click',function(){
						/*
						$vm.load_module_by_name(_module.var.panel,$vm.root_layout_content_slot,{
                            staff_name:records[I].First_Name+' '+records[I].Last_Name,
                            staff_login_name:records[I].Login_Name,
                            staff_rid:records[I].ID,
                            staff_pid:_db_pid,
                            staff_uid:records[I].UID,
                        })
						*/
						$vm.load_module_by_name(_module.var.child_module,$vm.root_layout_content_slot,{
							parent_name:records[I].First_Name+' '+records[I].Last_Name,
							//parent_pid:_db_pid,
							//parent_uid:records[I].UID,
							parent_info:{
	                            staff_name:records[I].First_Name+' '+records[I].Last_Name,
	                            staff_login_name:records[I].Login_Name,
	                            staff_rid:records[I].ID,
	                            staff_pid:_db_pid,
	                            staff_uid:records[I].UID,
							}
                        })
                    })
                    break;
                case 'Photo':
                    VmInclude:__BASE__/vmiis/Common-Code/grid/field_image.js
                break;
                case 'Gender':
                    VmInclude:__BASE__/vmiis/Common-Code/grid/field_gender.js
                break;
                case 'Department':
                    var sql="with tb as (select distinct name=S1,UID from [TABLE-"+_module.var.department_tid+"]) select name, value=name,value2=UID from tb where name like '%'+@S1+'%' ";
                    VmInclude:__BASE__/vmiis/Common-Code/grid/field_auto.js
                break;
            }
        }
        //-------------------------------------
        _before_submit=function(record,dbv){
            dbv.S1=record.Department;
            dbv.S2=record.Login_Name;
            dbv.S3=record.First_Name+" "+record.Last_Name;
            return true;
        };
        //-------------------------------------
        _new_pre_data_process=function(){
            _records[0].Department=$('#department__ID').val();
        };
        //-------------------------------------
		_set_req=function(){
			var where=" S1 like '%'+@S2+'%' "
			var sql="with tb as (select S1,S2,Information,PID,ID,UID,PUID,DateTime,Author,Modified,RowNum=row_number() over (order by ID DESC) from [TABLE-"+_db_pid+"-@S1] where "+where+")";
			sql+="select S1,S2,Information,PID,ID,UID,PUID,DateTime,Author,Modified,RowNum from tb where RowNum between @I6 and @I7";
			var sql_n="select count(ID) from [TABLE-"+_db_pid+"-@S1] where "+where;
			_req={cmd:'query_records',sql:sql,sql_n:sql_n,s1:'"'+$('#keyword__ID').val()+'"',s2:$('#department__ID').val(),I:$('#I__ID').text(),page_size:$('#page_size__ID').val()}
		}
		//-------------------------------------
		/*
		if(_module.var.panel!=undefined && typeof _module.var.panel!=='string'){
			var obj=_module.var.panel;
			obj.var=_module.var;
			var module_name="M"+_module.var.UID+"_staff_child_record_panel";
			$vm.module_list[module_name]=obj;
			_module.var.panel=module_name;
		}
		*/
		//--------------------------------------------------------
		if(_module.var.child_module!=undefined && typeof _module.var.child_module!=='string'){
			var obj=_module.var.child_module;
			obj.var=_module.var;
			var module_name="M"+_module.var.UID+"_staff_child_module";
			$vm.module_list[module_name]=obj;
			_module.var.child_module=module_name;
		}
		//--------------------------------------------------------
    }
</script>
<style>
    VmInclude:__BASE__/vmiis/Common-Code/grid/grid.css
</style>
